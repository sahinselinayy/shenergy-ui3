<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <title>YTD Learning – Şebeke Yönetim Arayüzü</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <style>
    :root {
      --ener-yellow: #f9a825;
      --ener-blue: #145da0;
      --bg-main: #020617;
      --text: #e5e7eb;
      --text-muted: #9ca3af;
      --border: #1f2937;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: system-ui, -apple-system, sans-serif;
      background: var(--bg-main);
      color: var(--text);
      display: flex;
      justify-content: center;
      min-height: 100vh;
    }
    .app {
      max-width: 1400px; width: 100%; display: grid; 
      grid-template-columns: 260px 1fr; gap: 20px; padding: 20px;
    }
    /* SIDEBAR */
    .sidebar {
      background: linear-gradient(145deg, #0f172a, #0f172a);
      border-radius: 20px; padding: 20px; border: 1px solid rgba(255,255,255,0.1);
    }
    .logo-box { display: flex; align-items: center; gap: 10px; margin-bottom: 20px; }
    .logo-title { font-weight: bold; font-size: 18px; color: var(--ener-yellow); }
    .menu-btn {
      width: 100%; background: transparent; border: none; color: var(--text-muted);
      padding: 10px; text-align: left; cursor: pointer; border-radius: 8px; margin-top: 5px;
    }
    .menu-btn.active, .menu-btn:hover {
      background: rgba(20, 93, 160, 0.2); color: white; border: 1px solid rgba(20, 93, 160, 0.5);
    }
    /* MAIN */
    .main {
      background: #0f172a; border-radius: 20px; border: 1px solid rgba(255,255,255,0.1);
      display: flex; flex-direction: column; overflow: hidden; height: 95vh;
    }
    .topbar {
      padding: 15px 20px; border-bottom: 1px solid rgba(255,255,255,0.1);
      display: flex; justify-content: space-between; align-items: center;
      background: rgba(15, 23, 42, 0.95);
    }
    .content { padding: 20px; overflow-y: auto; flex: 1; }
    .view { display: none; }
    .view.active { display: block; }
    
    /* KPI */
    .kpi-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px; }
    .kpi-card {
      background: #1e293b; padding: 15px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.05);
    }
    .kpi-value { font-size: 24px; font-weight: bold; margin-top: 5px; }
    
    /* TABLE */
    .table-wrapper { overflow-x: auto; background: #1e293b; border-radius: 12px; padding: 10px; }
    table { width: 100%; border-collapse: collapse; min-width: 800px; }
    th, td { padding: 12px; text-align: left; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 13px; }
    th { color: var(--text-muted); font-size: 12px; text-transform: uppercase; }
    
    /* UTILS */
    .primary-button {
      background: linear-gradient(90deg, var(--ener-blue), var(--ener-yellow));
      border: none; padding: 12px 20px; color: black; font-weight: bold; border-radius: 8px; cursor: pointer;
    }
    .badge { padding: 3px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; }
    .risk-Yüksek { background: rgba(239,68,68,0.2); color: #ef4444; }
    .risk-Orta { background: rgba(234,179,8,0.2); color: #eab308; }
    .risk-Düşük { background: rgba(34,197,94,0.2); color: #4ade80; }

    /* DETAIL CARD */
    .detail-card {
        background: #1e293b; padding: 20px; border-radius: 12px; border: 1px solid var(--ener-blue);
        max-width: 500px; display: none;
    }
    .progress-bar { width: 100%; background: #334155; height: 10px; border-radius: 5px; margin: 10px 0; }
    .progress-fill { height: 100%; background: linear-gradient(90deg, red, yellow, green); width: 0%; border-radius: 5px; transition: width 1s; }

    /* MOBILE */
    @media (max-width: 900px) {
      .app { grid-template-columns: 1fr; padding: 0; }
      .sidebar { display: none; } 
      .kpi-grid { grid-template-columns: 1fr 1fr; }
    }
  </style>
</head>
<body>

<div class="app">
  <aside class="sidebar">
    <div class="logo-box">
      <div class="logo-title">YTD Learning</div>
    </div>
    <button class="menu-btn active" onclick="switchView('dashboard', this)">Genel Bakış</button>
    <button class="menu-btn" onclick="switchView('assets', this)">Varlık Listesi (450)</button>
    <button class="menu-btn" onclick="switchView('detail', this)">Detay Profili</button>
  </aside>

  <main class="main">
    <div class="topbar">
      <div>
        <div style="font-weight:bold; font-size:16px;">Yatırım Karar Destek Sistemi</div>
        <div style="font-size:12px; color:var(--text-muted);">v2.1 - 450 Varlık Tam Veri</div>
      </div>
      <div style="font-size:12px; background:#334155; padding:5px 10px; border-radius:20px;">
        Bütçe: {{ kpi.budget }} Birim
      </div>
    </div>

    <div class="content">
      
      <div id="dashboard" class="view active">
        <h2 style="margin-bottom:15px;">Şebeke Özeti</h2>
        <div class="kpi-grid">
          <div class="kpi-card">
            <div style="color:var(--text-muted); font-size:12px;">Toplam Varlık</div>
            <div class="kpi-value">{{ kpi.total_assets }}</div>
          </div>
          <div class="kpi-card">
            <div style="color:var(--text-muted); font-size:12px;">Yüksek Riskli</div>
            <div class="kpi-value" style="color:#ef4444;">{{ kpi.high_risk_count }}</div>
          </div>
          <div class="kpi-card">
            <div style="color:var(--text-muted); font-size:12px;">Ort. Sağlık Skoru</div>
            <div class="kpi-value">{{ kpi.avg_health }}</div>
          </div>
          <div class="kpi-card">
            <div style="color:var(--text-muted); font-size:12px;">Planlanan Bütçe</div>
            <div class="kpi-value" style="color:var(--ener-yellow);">{{ kpi.budget }}</div>
          </div>
        </div>
      </div>

      <div id="assets" class="view">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h2>Varlık Listesi & Optimizasyon</h2>
            <button id="opt-btn" class="primary-button" onclick="runOptimization()">Optimizasyonu Çalıştır</button>
        </div>

        <div id="opt-result" style="display:none; background:rgba(20,93,160,0.2); padding:15px; border-radius:10px; margin-bottom:20px; border:1px solid var(--ener-blue);">
            <h4 style="color:var(--ener-yellow); margin-bottom:10px;">Yatırım Planı Oluşturuldu</h4>
            <div id="opt-summary" style="font-size:13px; color:#e5e7eb;"></div>
            <div style="margin-top:10px; max-height:200px; overflow-y:auto; background:rgba(0,0,0,0.2); padding:10px; border-radius:5px;">
                <ul id="opt-list" style="padding-left:20px; font-size:12px;"></ul>
            </div>
        </div>

        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>ID</th>
                <th>Talep No</th>
                <th>Grup</th>
                <th>SAIDI</th>
                <th>SAIFI</th>
                <th>Maliyet</th>
                <th>Sağlık</th>
                <th>Risk</th>
                <th>İşlem</th>
              </tr>
            </thead>
            <tbody id="assets-tbody">
              </tbody>
          </table>
        </div>
      </div>

      <div id="detail" class="view">
        <h2>Varlık Detay</h2>
        <div id="detail-placeholder" style="color:var(--text-muted);">Lütfen listeden bir varlık seçin.</div>
        
        <div id="detail-card" class="detail-card">
            <h3 style="color:var(--ener-yellow); margin-bottom:10px;" id="d-title">-</h3>
            <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                <span>Grup:</span> <strong id="d-group">-</strong>
            </div>
            <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                <span>Maliyet:</span> <strong id="d-cost">-</strong>
            </div>
            <hr style="border-color:rgba(255,255,255,0.1);">
            <div style="margin-top:10px;">
                <span style="font-size:12px; color:var(--text-muted);">SAĞLIK SKORU</span>
                <div class="progress-bar"><div id="d-bar" class="progress-fill"></div></div>
                <div style="text-align:right; font-weight:bold;" id="d-health">-</div>
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:20px;">
                <div style="background:rgba(0,0,0,0.3); padding:10px; border-radius:5px;">
                    <div style="font-size:11px; color:var(--text-muted);">SAIDI</div>
                    <div style="font-weight:bold;" id="d-saidi">-</div>
                </div>
                <div style="background:rgba(0,0,0,0.3); padding:10px; border-radius:5px;">
                    <div style="font-size:11px; color:var(--text-muted);">SAIFI</div>
                    <div style="font-weight:bold;" id="d-saifi">-</div>
                </div>
            </div>
        </div>
      </div>

    </div>
  </main>
</div>

<script>
    // KRİTİK NOKTA: Veriyi Flask'tan JSON olarak alıyoruz.
    // Artık elle yazılmış veri yok!
    const assetsData = {{ assets | tojson }};

    // Tabloyu Doldur
    const tbody = document.getElementById("assets-tbody");
    
    // 450 varlığın hepsini göstermek istedin
    const displayData = assetsData; 

    let rowsHtml = "";
    displayData.forEach(item => {
        rowsHtml += `
            <tr>
                <td>${item.id}</td>
                <td>${item.talep_no}</td>
                <td>${item.group}</td>
                <td>${item.saidi.toFixed(4)}</td>
                <td>${item.saifi.toFixed(4)}</td>
                <td>${item.cost}</td>
                <td><strong>${item.health_ui}</strong></td>
                <td><span class="badge risk-${item.risk_label}">${item.risk_label}</span></td>
                <td><button style="padding:5px 10px; border:1px solid #64748b; background:transparent; color:white; border-radius:4px; cursor:pointer;" onclick="showDetail(${item.id})">Seç</button></td>
            </tr>
        `;
    });
    tbody.innerHTML = rowsHtml;

    // Görünüm Değiştirme
    function switchView(viewId, btn) {
        document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
        document.getElementById(viewId).classList.add('active');
        
        document.querySelectorAll('.menu-btn').forEach(el => el.classList.remove('active'));
        if(btn) btn.classList.add('active');
    }

    // Detay Gösterme
    window.showDetail = function(id) {
        const item = assetsData.find(a => a.id === id);
        if(!item) return;

        document.getElementById('d-title').innerText = item.talep_no;
        document.getElementById('d-group').innerText = item.group;
        document.getElementById('d-cost').innerText = item.cost + " Birim";
        document.getElementById('d-health').innerText = item.health_ui + " / 100";
        document.getElementById('d-saidi').innerText = item.saidi.toFixed(5);
        document.getElementById('d-saifi').innerText = item.saifi.toFixed(5);
        
        document.getElementById('d-bar').style.width = item.health_ui + "%";

        document.getElementById('detail-placeholder').style.display = 'none';
        document.getElementById('detail-card').style.display = 'block';

        switchView('detail');
        document.querySelectorAll('.menu-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.menu-btn')[2].classList.add('active');
    }

    // Optimizasyon Çağrısı
    window.runOptimization = function() {
        const btn = document.getElementById('opt-btn');
        btn.innerText = "Hesaplanıyor...";
        btn.disabled = true;

        fetch('/api/optimize')
            .then(response => response.json())
            .then(data => {
                const resBox = document.getElementById('opt-result');
                const summary = document.getElementById('opt-summary');
                const list = document.getElementById('opt-list');

                resBox.style.display = 'block';
                summary.innerHTML = `
                    Toplam Bütçe: <strong>${data.budget}</strong> | 
                    Kullanılan: <strong>${data.used_budget}</strong> | 
                    Seçilen Varlık: <strong>${data.selected_count}</strong> Adet
                `;

                let listHtml = "";
                // Listede sadece ilk 50 taneyi gösterelim ki kutu taşmasın
                data.selected.slice(0,50).forEach(item => {
                    listHtml += `<li><b>${item.talep_no}</b> (${item.grup}) - Maliyet: ${item.maliyet} - Skor: ${item.skor}</li>`;
                });
                if(data.selected.length > 50) {
                    listHtml += `<li>... ve ${data.selected.length - 50} adet daha.</li>`;
                }
                list.innerHTML = listHtml;

                btn.innerText = "Tekrar Çalıştır";
                btn.disabled = false;
            })
            .catch(err => {
                alert("Hata oluştu: " + err);
                btn.innerText = "Optimizasyonu Çalıştır";
                btn.disabled = false;
            });
    }
</script>

</body>
</html>
